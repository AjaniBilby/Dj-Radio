<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Dj Library</title>
    <style>
      body{
        margin: 0;
        overflow: hidden;
      }

      p{
        color: white;
      }

      h1{
        font-family: Montserrat, arial, sans-serif;
        margin: 10px 0px 10px 0px;
      }

      h2{
        font-family: Montserrat-Light, arial, sans-serif;
        margin: 10px 0px 10px 0px;
      }

      h3{
        font-family: Montserrat-UltraLight, arial, sans-serif;
        margin: 10px 0px 10px 0px;
      }

      h4{
        font-family: Montserrat-Hairline, arial, sans-serif;
        margin: 5px 0px 5px 0px;
      }

      h5{
        font-family: Montserrat-Hairline, arial, sans-serif;
        margin: 5px 0px 5px 0px;
      }

      table{
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
      }

      td, th{
        border: 1px solid #dddddd;
        font-weight: normal;
        text-align: left;
        padding: 0px;
      }

      tr:nth-child(even){
        background-color: #dddddd;
      }
    </style>
    <style>
      #container{
        overflow-y: auto;
        height: 100vh;
        display: block;
      }

      #popup-zone{
        z-index: 100;
        position: absolute;
        right: 0px;
        bottom: 0px;
        height: 100vh;
        width: 200px;
        vertical-align: bottom;
      }

      .popup{
        height: 0px;
        overflow-y: hidden;
        border-radius: 5px;
        background-color: rgb(0, 71, 255);
        transition: height 1s;
      }

      .song-row{
        cursor: pointer;
        background-color: transparent;
        transition: background-color 0.5s;
      }
      .song-row:hover{
        background-color: rgb(130, 218, 255);
      }
    </style>
    <script id="network-functions">
      function Stream(url, callback, objectify){
        var stream = new XMLHttpRequest();
        var prevLength = 0;
        stream.onprogress = function(data){
          var newLength = data.currentTarget.responseText.length;
          var pass = data.currentTarget.responseText.substr(newLength-(newLength-prevLength), newLength);
          prevLength = newLength;

          if (objectify){
            try {
              data = JSON.parse(pass);
            }catch (e){
              console.error('Data is not valid JSON \n('+pass+')\nReason: '+e+'\n');
            }finally{
              callback(data);
            }
          }else{
            callback(pass);
          }
        };
        stream.open("GET", url, true);
        stream.send();

        stream.ontimeout = function(){
          Stream(url, callback, objectify);
          delete stream;
        };

        stream.onreadystatechange = function() {
          if (stream.readyState == 4 && stream.status == 200){
            Stream(url, callback, objectify);
            delete stream;
          }
        };

        return stream;
      }
      function RequestData(file, callback, objectify = true){
        var data = "";
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
          if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
            var resData = xmlhttp.responseText;
            if (objectify === true){
              resData = JSON.parse(resData);
            }
            if (typeof(callback) == "function"){
              callback(resData);
            }
            return resData;
          }
        };
        xmlhttp.open("GET", file, true);
        xmlhttp.send();

        return xmlhttp;
      }
    </script>

    <script>
      var request;
      var cache = {
        songSetData: {}
      }

      function DrawSongs(data, title, sortBy){
        document.getElementById('album').style.display = 'none';
        document.getElementById('artist').style.display = 'none';
        document.getElementById('genre').style.display = 'none';
        document.getElementById('title').style.display = 'none';
        document.getElementById('songs').style.display = 'block';

        document.getElementById('songs').innerHTML = '<h1>'+title+'</h1>';

        data.sort(function(first, second){
          a = first[sortBy];
          b = second[sortBy];

          if (typeof(a) == 'object'){
            first[sortBy].sort(function(first, second){
              if (a > b){
                return 1;
              }else if (a < b){
                return -1;
              }else{
                return 0;
              }
            });
            a = first[sortBy][0];
          }
          if (typeof(b) == 'object'){
            second[sortBy].sort(function(first, second){
              if (a > b){
                return 1;
              }else if (a < b){
                return -1;
              }else{
                return 0;
              }
            });
            b = second[sortBy][0];
          }

          //Make sure that all numbers are numbers not strings
          if (!isNaN(a)){
            a = parseFloat(a);
          }
          if (!isNaN(a)){
            b = parseFloat(b);
          }

          if (a > b){
            return 1;
          }else if (a < b){
            return -1;
          }else{
            return 0;
          }
        });

        var table = document.createElement('TABLE');
        table.innerHTML += `<tr>
        <th onclick="DrawSongs(cache.songSetData, '${title}', 'title')"><h3>Title</h3></th>
        <th onclick="DrawSongs(cache.songSetData, '${title}', 'album')"><h3>Album</h3></th>
        <th onclick="DrawSongs(cache.songSetData, '${title}', 'artist')"><h3>Artist</h3></th>
        <th onclick="DrawSongs(cache.songSetData, '${title}', 'genre')"><h3>Genre</h3></th>
        <th onclick="DrawSongs(cache.songSetData, '${title}', 'no')"><h3>Track</h3></th>
        </tr>`

        for (let index in data){
          var row = document.createElement('tr');
          row.className = "song-row";
          row.innerHTML += '<th>'+data[index].title+'</th>';
          row.innerHTML += '<th>'+data[index].album+'</th>';
          row.innerHTML += '<th>'+data[index].artist.join(', ')+'</th>';
          row.innerHTML += '<th>'+data[index].genre.join(', ')+'</th>';
          row.innerHTML += '<th>'+data[index].no+'</th>';
          table.appendChild(row);

          row.onclick = function(evt){
            var popup = document.createElement('div');
            popup.className = 'popup';
            document.getElementById('popup-zone').appendChild(popup);
            popup.innerHTML = 'Queueing '+data[index].id;
            popup.style.height = '50px';

            RequestData(location.origin+'/dj/request/'+data[index].id, function(){
              popup.innerHTML = 'Queued '+data[index].id;
              setTimeout(function () {
                popup.style.height = '0px';
              }, 1000);
            });
          };
        };

        document.getElementById('songs').appendChild(table);
      }
      function Show(type){
        document.getElementById('songs').innerHTML = 'Loading...';

        document.getElementById('album').style.display = 'none';
        document.getElementById('artist').style.display = 'none';
        document.getElementById('genre').style.display = 'none';
        document.getElementById('title').style.display = 'none';
        document.getElementById('songs').style.display = 'none';
        document.getElementById(type).style.display = 'block';

        request = RequestData(location.origin+'/dj/list/'+type, function(data){
          document.getElementById(type).innerHTML = '';
          data.sort(function(a, b){
            a = a.toLowerCase();
            b = b.toLowerCase();

            if (a > b){
              return 1;
            }else if (a < b){
              return -1;
            }else{
              return 0;
            }
          });
          for (let item of data){
            var element = document.createElement('DIV');
            element.innerHTML += item;
            document.getElementById(type).appendChild(element);
            element.onclick = function(evt){
              console.log('click');
              ShowSongsOfType(type, item)
            };
          };
        }, true);
      };
      function ShowSongsOfType(type, item){
        document.getElementById('album').style.display = 'none';
        document.getElementById('artist').style.display = 'none';
        document.getElementById('genre').style.display = 'none';
        document.getElementById('title').style.display = 'none';
        document.getElementById('songs').style.display = 'block';

        RequestData(location.origin+'/dj/list/'+type+'/'+item, function(data){
          document.getElementById('songs').innerHTML = '<h1>'+item+'</h1><br>Loading...';
          data.sort(function(a, b){
            if (typeof(a) == 'string'){
              a = a.toLowerCase();
            }
            if (typeof(b) == 'string'){
              b = b.toLowerCase();
            }

            if (a > b){
              return 1;
            }else if (a < b){
              return -1;
            }else{
              return 0;
            }
          });

          RequestData(location.origin+'/dj/song/meta/'+data.join(','), function(songData){
            for (let item in songData){
              songData[item].id = data[item];
            }

            cache.songSetData = songData;

            var sortBy = 'title';

            if (type == 'album'){
              sortBy = 'no';
            }

            DrawSongs(songData, item, sortBy);
          });
        }, true);
      };
    </script>
  </head>
  <body>
    <button onclick="Show('title')">Title</button><button onclick="Show('album')">Album</button><button onclick="Show('artist')">Artist</button><button onclick="Show('genre')">Genre</button>
    <div id="container">
      <div id="album"></div>
      <div id="artist"></div>
      <div id="genre"></div>
      <div id="title"></div>
      <div id="songs"></div>
    </div>
    <div id="popup-zone"></div>
  </body>
</html>
