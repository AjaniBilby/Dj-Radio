<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Dj Library</title>
    <style>
      body{
        margin: 0;
        overflow: hidden;
      }

      p{
        color: white;
      }

      h1{
        font-family: Montserrat;
        margin: 10px 0px 10px 0px;
        color: white;
      }

      h2{
        font-family: Montserrat-Light;
        margin: 10px 0px 10px 0px;
        color: rgb(230, 230, 230);
      }

      h3{
        font-family: Montserrat-UltraLight;
        margin: 10px 0px 10px 0px;
        color: rgb(220, 220, 220);
      }

      h4{
        font-family: Montserrat-Hairline;
        margin: 5px 0px 5px 0px;
        color: rgb(210, 210, 210);
      }

      h5{
        font-family: Montserrat-Hairline;
        margin: 5px 0px 5px 0px;
        color: rgb(200, 200, 200)
      }
    </style>
    <style>
      #container{
        overflow-y: auto;
        height: 100vh;
        display: block;
      }
    </style>
    <script id="network-functions">
      function Stream(url, callback, objectify){
        var stream = new XMLHttpRequest();
        var prevLength = 0;
        stream.onprogress = function(data){
          var newLength = data.currentTarget.responseText.length;
          var pass = data.currentTarget.responseText.substr(newLength-(newLength-prevLength), newLength);
          prevLength = newLength;

          if (objectify){
            try {
              data = JSON.parse(pass);
            }catch (e){
              console.error('Data is not valid JSON \n('+pass+')\nReason: '+e+'\n');
            }finally{
              callback(data);
            }
          }else{
            callback(pass);
          }
        };
        stream.open("GET", url, true);
        stream.send();

        stream.ontimeout = function(){
          Stream(url, callback, objectify);
          delete stream;
        };

        stream.onreadystatechange = function() {
          if (stream.readyState == 4 && stream.status == 200){
            Stream(url, callback, objectify);
            delete stream;
          }
        };

        return stream;
      }
      function RequestData(file, callback, objectify = true){
        var data = "";
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
          if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
            var resData = xmlhttp.responseText;
            if (objectify === true){
              resData = JSON.parse(resData);
            }
            if (typeof(callback) == "function"){
              callback(resData);
            }
            return resData;
          }
        };
        xmlhttp.open("GET", file, true);
        xmlhttp.send();

        return xmlhttp;
      }
    </script>

    <script>
      var request;
      function Show(type){
        document.getElementById('songs').innerHTML = 'Loading...';

        document.getElementById('album').style.display = 'none';
        document.getElementById('artist').style.display = 'none';
        document.getElementById('genre').style.display = 'none';
        document.getElementById('title').style.display = 'none';
        document.getElementById('songs').style.display = 'none';
        document.getElementById(type).style.display = 'block';

        request = RequestData(location.origin+'/dj/list/'+type, function(data){
          document.getElementById(type).innerHTML = '';
          data.sort(function(a, b){
            a = a.toLowerCase();
            b = b.toLowerCase();

            if (a > b){
              return 1;
            }else if (a < b){
              return -1;
            }else{
              return 0;
            }
          });
          for (let item of data){
            var element = document.createElement('DIV');
            element.innerHTML += item;
            document.getElementById(type).appendChild(element);
            element.onclick = function(evt){
              console.log('click');
              ShowSongsOfType(type, item)
            };
          };
        }, true);
      };
      function ShowSongsOfType(type, item){
        document.getElementById('album').style.display = 'none';
        document.getElementById('artist').style.display = 'none';
        document.getElementById('genre').style.display = 'none';
        document.getElementById('title').style.display = 'none';
        document.getElementById('songs').style.display = 'block';

        RequestData(location.origin+'/dj/list/'+type+'/'+item, function(data){
          document.getElementById('songs').innerHTML = 'Loading...';
          data.sort(function(a, b){
            if (typeof(a) == 'string'){
              a = a.toLowerCase();
            }
            if (typeof(b) == 'string'){
              b = b.toLowerCase();
            }

            if (a > b){
              return 1;
            }else if (a < b){
              return -1;
            }else{
              return 0;
            }
          });

          RequestData(location.origin+'/dj/song/meta/'+data.join(','), function(songData){
            document.getElementById('songs').innerHTML = '';
            for (let index in songData){
              var element = document.createElement('DIV');
              element.innerHTML += songData[index].title;
              element.onclick = function(evt){
                RequestData(location.origin+'/dj/request/'+data[index], function(){
                  alert('Queued '+data[index]);
                });
              };
              document.getElementById('songs').appendChild(element);
            };
          });
        }, true);
      };
    </script>
  </head>
  <body>
    <button onclick="Show('title')">Title</button><button onclick="Show('album')">Album</button><button onclick="Show('artist')">Artist</button><button onclick="Show('genre')">Genre</button>
    <div id="container">
      <div id="album"></div>
      <div id="artist"></div>
      <div id="genre"></div>
      <div id="title"></div>
      <div id="songs"></div>
    </div>
  </body>
</html>
